<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SecureVote â€“ Admin Dashboard</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  body { background: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
  .card { border-radius: 15px; padding: 20px; text-align: center; transition: 0.3s; }
  .status-upcoming { background: #cce5ff; color: #004085; }
  .status-ongoing { background: #d4edda; color: #155724; }
  .status-ended { background: #f8d7da; color: #721c24; }
  #countdown { font-size: 1.2rem; font-weight: bold; margin-top: 10px; }

  /* Live Voting Panel */
  .live-voting-card { margin-top: 30px; }
  .candidate-box { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; background: #f8f9fa; margin-bottom: 10px; }
  .candidate-info { display: flex; align-items: center; gap: 10px; }
  .candidate-info img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; }
  .progress { height: 12px; border-radius: 10px; flex:1; margin-left: 15px; }
</style>
</head>
<body>
<div class="container py-5">
  <div class="d-flex justify-content-between mb-4">
    <a href="candidates.html" class="btn btn-outline-primary"><i class="fas fa-users-cog"></i> Manage Candidates</a>
    <a href="registerd -voters.html" class="btn btn-outline-primary"><i class="fas fa-users-cog"></i> registered_voters</a>
    <button class="btn btn-outline-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>

  <h3 class="mb-4 text-center"><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h3>

  <!-- Voting Schedule Cards -->
  <div class="row g-4">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <h5><i class="fas fa-calendar-plus"></i> Voting Start</h5>
        <p id="startDate" class="fw-bold text-primary"></p>
        <p id="startTime"></p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <h5><i class="fas fa-calendar-check"></i> Voting End</h5>
        <p id="endDate" class="fw-bold text-danger"></p>
        <p id="endTime"></p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm" id="statusCard">
        <h5><i class="fas fa-hourglass-half"></i> Status</h5>
        <p id="votingStatus" class="fw-bold fs-5"></p>
        <p id="countdown"></p>
      </div>
    </div>
  </div>

  <!-- Live Voting Panel -->
  <div class="live-voting-card">
    <h4 class="mt-4"><i class="fas fa-chart-bar me-2"></i> Live Voting Counts</h4>
    <div id="liveVotesContainer"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const schedule = JSON.parse(localStorage.getItem("votingSchedule"));
  const logoutBtn = document.getElementById("logoutBtn");
  const liveVotesContainer = document.getElementById("liveVotesContainer");

  if (!schedule) {
    document.getElementById("startDate").textContent = "Not Set";
    document.getElementById("endDate").textContent = "Not Set";
    document.getElementById("votingStatus").textContent = "No Schedule";
    document.getElementById("countdown").textContent = "";
    liveVotesContainer.innerHTML = "<p class='text-muted'>No live voting available.</p>";
    return;
  }

  const start = new Date(schedule.start);
  const end = new Date(schedule.end);

  document.getElementById("startDate").textContent = start.toDateString();
  document.getElementById("startTime").textContent = start.toLocaleTimeString();
  document.getElementById("endDate").textContent = end.toDateString();
  document.getElementById("endTime").textContent = end.toLocaleTimeString();

  function updateStatus() {
    const now = new Date();
    const statusCard = document.getElementById("statusCard");
    const countdownEl = document.getElementById("countdown");
    const statusEl = document.getElementById("votingStatus");

    statusCard.className = "card shadow-sm";

    if (now < start) {
      statusEl.textContent = "Upcoming";
      statusCard.classList.add("status-upcoming");
      countdownEl.textContent = "Starts in " + formatTime(start - now);
    } else if (now >= start && now <= end) {
      statusEl.textContent = "Ongoing";
      statusCard.classList.add("status-ongoing");
      countdownEl.textContent = "Ends in " + formatTime(end - now);
    } else {
      statusEl.textContent = "Ended";
      statusCard.classList.add("status-ended");
      countdownEl.textContent = "Voting period has ended.";
    }
  }

  function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const days = Math.floor(totalSeconds / (3600*24));
    const hours = Math.floor((totalSeconds % (3600*24)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  function renderLiveVotes() {
    const candidates = JSON.parse(localStorage.getItem("candidates")) || [];
    const votesList = JSON.parse(localStorage.getItem("votesList")) || [];
    const positions = [...new Set(candidates.map(c => c.position))];

    liveVotesContainer.innerHTML = "";
    positions.forEach(pos => {
      const group = candidates.filter(c => c.position === pos);
      if (!group.length) return;

      let votesForPosition = votesList.map(v => v.ballot[pos]).filter(Boolean);
      let totalVotes = votesForPosition.length;

      let html = `<h5 class="mt-3">${pos}</h5>`;
      group.forEach(cand => {
        let candVotes = votesForPosition.filter(v => v === cand.name).length;
        let percentage = totalVotes > 0 ? ((candVotes / totalVotes) * 100).toFixed(1) : 0;

        html += `
          <div class="candidate-box">
            <div class="candidate-info">
              <img src="${cand.image}" alt="Profile">
              <strong>${cand.name}</strong>
            </div>
            <div class="progress">
              <div class="progress-bar bg-primary" role="progressbar" style="width:${percentage}%"></div>
            </div>
            <small class="ms-2">${candVotes} votes (${percentage}%)</small>
          </div>
        `;
      });

      liveVotesContainer.innerHTML += html;
    });
  }

  // Initial load
  updateStatus();
  renderLiveVotes();

  // Update every second
  setInterval(() => {
    updateStatus();
    renderLiveVotes();
  }, 1000);

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
  });
});
</script>
</body>
</html>
