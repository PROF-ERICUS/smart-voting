<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SecureVote – Results</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  body { background: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  .page-header { margin-bottom: 25px; }
  .card { border-radius: 15px; transition: 0.3s; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 8px 18px rgba(0,0,0,0.15); }
  .candidate-img {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 50%;
    margin: 15px auto 10px auto;
    display: block;
    border: 4px solid #f1f1f1;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  #countdown { font-weight: bold; color: #d9534f; margin-bottom: 15px; }
</style>
</head>
<body>
<div class="container py-5">
  <div class="page-header text-center">
    <h3><i class="fas fa-chart-bar me-2"></i> Election Results</h3>
    <p id="countdown"></p>
  </div>

  <div id="resultsContent" class="row g-4"></div>

  <div class="d-flex justify-content-center mt-4">
    <a href="vote.html" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Back to Vote</a>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const resultsContent = document.getElementById("resultsContent");
  const countdownEl = document.getElementById("countdown");
  const placeholderImg = "https://via.placeholder.com/150?text=No+Image";

  let candidates = JSON.parse(localStorage.getItem("candidates")) || [];
  let positions = [...new Set(candidates.map(c => c.position))];

  function formatTime(ms) {
    const d = Math.floor(ms / (1000*60*60*24));
    const h = Math.floor((ms % (1000*60*60*24)) / (1000*60*60));
    const m = Math.floor((ms % (1000*60*60)) / (1000*60));
    const s = Math.floor((ms % (1000*60)) / 1000);
    return `${d}d ${h}h ${m}m ${s}s`;
  }

  function renderResults(votesList) {
    resultsContent.innerHTML = "";

    positions.forEach(pos => {
      const group = candidates.filter(c => c.position === pos);
      let voteCounts = {};
      group.forEach(c => voteCounts[c.name] = 0);

      votesList.forEach(vote => {
        if (vote.ballot[pos]) {
          const candName = vote.ballot[pos];
          if (voteCounts[candName] !== undefined) voteCounts[candName]++;
        }
      });

      let html = `<div class="col-12"><h5 class="mt-3"><i class="fas fa-briefcase me-1"></i>${pos}</h5><div class="row g-3">`;

      group.forEach(cand => {
        const imgSrc = cand.image || placeholderImg;
        const count = voteCounts[cand.name] || 0;
        html += `
          <div class="col-md-4">
            <div class="card shadow-sm text-center p-3">
              <img src="${imgSrc}" class="candidate-img" alt="Profile">
              <h5 class="card-title">${cand.name}</h5>
              <p class="text-muted mb-1">Votes: <b>${count}</b></p>
            </div>
          </div>`;
      });

      html += `</div></div>`;
      resultsContent.innerHTML += html;
    });
  }

  function updateResults() {
    const votesList = JSON.parse(localStorage.getItem("votesList")) || [];
    const schedule = JSON.parse(localStorage.getItem("votingSchedule"));

    if (!schedule) {
      countdownEl.textContent = "⚠️ No voting schedule set.";
      resultsContent.innerHTML = "";
      return;
    }

    const now = new Date().getTime();
    const start = new Date(schedule.start).getTime();
    const end = new Date(schedule.end).getTime();

    if (now < start) {
      countdownEl.textContent = "⏳ Voting hasn't started yet. Results are hidden.";
      resultsContent.innerHTML = `<div class="alert alert-info text-center w-100">Results will appear after voting ends.</div>`;
    } else if (now >= start && now <= end) {
      const diff = end - now;
      countdownEl.textContent = "⏳ Voting ends in " + formatTime(diff) + ". Results are hidden until then.";
      resultsContent.innerHTML = `<div class="alert alert-info text-center w-100">Results are hidden until voting ends.</div>`;
    } else {
      countdownEl.textContent = "✅ Voting has ended. Final results below:";
      renderResults(votesList);
    }
  }

  updateResults();
  setInterval(updateResults, 1000); // refresh every second
});
</script>
</body>
</html>
