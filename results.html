<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SecureVote – Results</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    color: #fff;
  }

  .page-header { margin-bottom: 25px; text-align: center; }
  .page-header h3 { font-weight: 600; }
  .page-header p { color: #e0e0e0; }

  .card {
    border-radius: 15px;
    transition: 0.3s;
    background: #fff;
    color: #333;
    overflow: hidden;
    text-align: center;
    padding: 20px 10px;
    position: relative;
  }
  .card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.2); }

  .candidate-img {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 50%;
    margin: 15px auto 10px auto;
    display: block;
    border: 4px solid #f4f6f9;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .winner-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: gold;
    color: #333;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 50px;
    font-size: 0.85rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  #countdown {
    font-weight: bold;
    color: #ffd700;
    margin-bottom: 15px;
  }

  @media (max-width: 992px) { .col-md-4 { flex: 0 0 50%; max-width: 50%; } }
  @media (max-width: 576px) { .col-md-4 { flex: 0 0 100%; max-width: 100%; } .candidate-img { width: 120px; height: 120px; } }
</style>
</head>
<body>
<div class="container py-5">
  <div class="page-header">
    <h3><i class="fas fa-chart-bar me-2"></i> Election Results</h3>
    <p id="countdown"></p>
  </div>

  <div id="resultsContent" class="row g-4"></div>

  <div class="d-flex justify-content-center mt-4">
    <a href="vote.html" class="btn btn-outline-light"><i class="fas fa-arrow-left"></i> Back to Vote</a>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const resultsContent = document.getElementById("resultsContent");
  const countdownEl = document.getElementById("countdown");
  const placeholderImg = "https://via.placeholder.com/150?text=No+Image";

  let candidates = JSON.parse(localStorage.getItem("candidates")) || [];
  let positions = [...new Set(candidates.map(c => c.position))];

  function formatTime(ms) {
    const d = Math.floor(ms / (1000*60*60*24));
    const h = Math.floor((ms % (1000*60*60*24)) / (1000*60*60));
    const m = Math.floor((ms % (1000*60*60)) / (1000*60));
    const s = Math.floor((ms % (1000*60)) / 1000);
    return `${d}d ${h}h ${m}m ${s}s`;
  }

  function renderResults(votesList) {
    resultsContent.innerHTML = "";

    positions.forEach(pos => {
      const group = candidates.filter(c => c.position === pos);
      let voteCounts = {};
      group.forEach(c => voteCounts[c.name] = 0);

      votesList.forEach(vote => {
        if (vote.ballot[pos]) {
          const candName = vote.ballot[pos];
          if (voteCounts[candName] !== undefined) voteCounts[candName]++;
        }
      });

      // Determine winner(s)
      const maxVotes = Math.max(...Object.values(voteCounts));
      const winners = Object.keys(voteCounts).filter(name => voteCounts[name] === maxVotes && maxVotes > 0);

      let html = `<div class="col-12"><h5 class="mt-3 text-white"><i class="fas fa-briefcase me-1"></i>${pos}</h5><div class="row g-3">`;

      group.forEach(cand => {
        const imgSrc = cand.image || placeholderImg;
        const count = voteCounts[cand.name] || 0;
        html += `
          <div class="col-md-4">
            <div class="card shadow-sm">
              ${winners.includes(cand.name) ? '<div class="winner-badge"><i class="fas fa-trophy"></i> Winner</div>' : ''}
              <img src="${imgSrc}" class="candidate-img" alt="Profile">
              <h5 class="card-title">${cand.name}</h5>
              <p class="text-muted mb-1">Votes: <b>${count}</b></p>
            </div>
          </div>`;
      });

      html += `</div></div>`;
      resultsContent.innerHTML += html;
    });
  }

  function updateResults() {
    const votesList = JSON.parse(localStorage.getItem("votesList")) || [];
    const schedule = JSON.parse(localStorage.getItem("votingSchedule"));

    if (!schedule) {
      countdownEl.textContent = "⚠️ No voting schedule set.";
      resultsContent.innerHTML = "";
      return;
    }

    const now = new Date().getTime();
    const start = new Date(schedule.start).getTime();
    const end = new Date(schedule.end).getTime();

    if (now < start) {
      countdownEl.textContent = "⏳ Voting hasn't started yet. Results are hidden.";
      resultsContent.innerHTML = `<div class="alert alert-info text-center w-100">Results will appear after voting ends.</div>`;
    } else if (now >= start && now <= end) {
      const diff = end - now;
      countdownEl.textContent = "⏳ Voting ends in " + formatTime(diff) + ". Results are hidden until then.";
      resultsContent.innerHTML = `<div class="alert alert-info text-center w-100">Results are hidden until voting ends.</div>`;
    } else {
      countdownEl.textContent = "✅ Voting has ended. Final results below:";
      renderResults(votesList);
    }
  }

  updateResults();
  setInterval(updateResults, 1000);
});
</script>
</body>
</html>
