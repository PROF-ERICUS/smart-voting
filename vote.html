<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SecureVote – Vote</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  body { background: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  .page-header { margin-bottom: 25px; }
  .card { border-radius: 15px; transition: 0.3s; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 8px 18px rgba(0,0,0,0.15); }
  .candidate-img {
    width: 180px;
    height: 180px;
    object-fit: cover;
    border-radius: 50%;
    margin: 15px auto 10px auto;
    display: block;
    border: 4px solid #f1f1f1;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  #countdown { font-weight: bold; color: #0069d9; margin-top: 10px; }
</style>
</head>
<body>
<div class="container py-5">
  <div class="page-header text-center">
    <h3><i class="fas fa-vote-yea me-2"></i> Vote for Your Candidates</h3>
    <p class="text-muted">Select your preferred candidate for each position (or skip)</p>
    <p id="countdown"></p>
  </div>

  <form id="voteForm">
    <div id="candidatesList" class="row g-4"></div>
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary px-5"><i class="fas fa-paper-plane"></i> Submit Vote</button>
    </div>
  </form>

  <div id="voteStatusBox" class="mt-4 text-center"></div>

  <div class="d-flex justify-content-center gap-2 mt-4">
    <a href="results.html" class="btn btn-success"><i class="fas fa-chart-bar"></i> View Results</a>
    <button id="logoutBtn" class="btn btn-outline-secondary"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const candidatesList = document.getElementById("candidatesList");
  const voteForm = document.getElementById("voteForm");
  const voteStatusBox = document.getElementById("voteStatusBox");
  const countdownEl = document.getElementById("countdown");
  const logoutBtn = document.getElementById("logoutBtn");
  const placeholderImg = "https://via.placeholder.com/180?text=No+Image";

  let candidates = JSON.parse(localStorage.getItem("candidates")) || [];
  let positions = [...new Set(candidates.map(c => c.position))];

  // Render candidates
  function renderCandidates() {
    candidatesList.innerHTML = "";
    positions.forEach(pos => {
      const group = candidates.filter(c => c.position === pos);
      let html = `<div class="col-12"><h5 class="mt-3"><i class="fas fa-briefcase me-1"></i>${pos}</h5><div class="row g-3">`;

      group.forEach((cand, idx) => {
        const imgSrc = cand.image || placeholderImg;
        html += `
          <div class="col-md-4">
            <div class="card shadow-sm text-center p-3">
              <img src="${imgSrc}" class="candidate-img" alt="Profile">
              <h5 class="card-title">${cand.name}</h5>
              <div class="form-check mt-2">
                <input class="form-check-input" type="radio" name="${cand.position}" value="${cand.name}" id="${cand.position}-${idx}">
                <label class="form-check-label" for="${cand.position}-${idx}">Select</label>
              </div>
            </div>
          </div>
        `;
      });

      // "No Vote / Skip" option
      html += `
        <div class="col-md-4">
          <div class="card shadow-sm text-center p-3">
            <h5 class="card-title">No Vote / Skip</h5>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="${pos}" value="" id="${pos}-skip">
              <label class="form-check-label" for="${pos}-skip">Skip</label>
            </div>
          </div>
        </div>
      `;
      html += `</div></div>`;
      candidatesList.innerHTML += html;
    });
  }

  // Voting schedule check (auto reacts to admin stop/extend)
  function checkVotingSchedule() {
    function updateCountdown() {
      const schedule = JSON.parse(localStorage.getItem("votingSchedule"));
      const now = new Date().getTime();

      if (!schedule) {
        countdownEl.textContent = "⚠️ No voting schedule set.";
        voteForm.querySelector("button[type='submit']").disabled = true;
        return;
      }

      const start = new Date(schedule.start).getTime();
      const end = new Date(schedule.end).getTime();

      if (now < start) {
        countdownEl.textContent = "Voting starts in " + formatTime(start - now);
        voteForm.querySelector("button[type='submit']").disabled = true;
      } else if (now >= start && now <= end) {
        countdownEl.textContent = "Voting ends in " + formatTime(end - now);
        voteForm.querySelector("button[type='submit']").disabled = false;
      } else {
        countdownEl.textContent = "Voting has ended.";
        voteForm.querySelector("button[type='submit']").disabled = true;
      }
    }

    updateCountdown();
    setInterval(updateCountdown, 1000); // Keep checking for admin updates
  }

  function formatTime(ms) {
    const d = Math.floor(ms / (1000*60*60*24));
    const h = Math.floor((ms % (1000*60*60*24)) / (1000*60*60));
    const m = Math.floor((ms % (1000*60*60)) / (1000*60));
    const s = Math.floor((ms % (1000*60)) / 1000);
    return `${d}d ${h}h ${m}m ${s}s`;
  }

  // Voting form submission
  voteForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const schedule = JSON.parse(localStorage.getItem("votingSchedule"));
    const now = new Date().getTime();

    if (!schedule || now < new Date(schedule.start).getTime() || now > new Date(schedule.end).getTime()) {
      showMessage("danger", "Voting is not open right now.");
      return;
    }

    let ballot = {};
    positions.forEach(pos => {
      const selected = document.querySelector(`input[name="${pos}"]:checked`);
      ballot[pos] = selected ? selected.value : ""; 
    });

    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) {
      showMessage("danger", "Please log in to vote!");
      return;
    }

    let allVotes = JSON.parse(localStorage.getItem("votesList")) || [];
    if (allVotes.some(v => v.user === currentUser.username)) {
      showMessage("danger", "You have already voted!");
      return;
    }

    if (!confirm("Are you sure you want to submit your vote?")) return;

    allVotes.push({ user: currentUser.username, ballot });
    localStorage.setItem("votesList", JSON.stringify(allVotes));

    showMessage("success", "Vote submitted successfully!");
    voteForm.reset();
  });

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
  });

  function showMessage(type, msg) {
    voteStatusBox.innerHTML = `<div class="alert alert-${type}"><i class="fas fa-info-circle"></i> ${msg}</div>`;
    setTimeout(() => voteStatusBox.innerHTML = "", 4000);
  }

  renderCandidates();
  checkVotingSchedule(); // Auto reacts to schedule changes
});
</script>
</body>
</html>
