<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SecureVote – Vote</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
/* Body and Background */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(to right, #1c3c72, #2a5298);
  min-height: 100vh;
  color: #fff;
}

/* Page Header */
.page-header h3 { font-weight: bold; }
.page-header p { margin-bottom: 0.5rem; }

/* Candidate Cards */
.card {
  border-radius: 15px;
  transition: 0.3s;
  background: rgba(255,255,255,0.95);
  color: #333;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
.candidate-img {
  width: 140px;
  height: 140px;
  object-fit: cover;
  border-radius: 50%;
  margin: 10px auto;
  display: block;
  border: 4px solid #f1f1f1;
}

/* Countdown */
#countdown {
  font-weight: bold;
  font-size: 1.2rem;
  color: #ffc107;
  margin-top: 10px;
}

/* Buttons */
.btn-primary { background-color: #0069d9; border: none; }
.btn-primary:hover { background-color: #0056b3; }

/* Alerts */
.alert { font-weight: 500; }

/* Responsive */
@media (max-width: 768px) {
  .candidate-img { width: 120px; height: 120px; }
}
@media (max-width: 576px) {
  .candidate-img { width: 100px; height: 100px; }
}
</style>
</head>
<body>
<div class="container py-5">
  <div class="page-header text-center mb-4">
    <h3><i class="fas fa-vote-yea me-2"></i> Vote for Your Candidates</h3>
    <p class="text-light">Select your preferred candidate for each position (or skip)</p>
    <p id="countdown"></p>
  </div>

  <form id="voteForm">
    <div id="candidatesList" class="row g-4"></div>
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-primary px-5"><i class="fas fa-paper-plane"></i> Submit Vote</button>
    </div>
  </form>

  <div id="voteStatusBox" class="mt-4 text-center"></div>

  <div class="d-flex justify-content-center gap-2 mt-4 flex-wrap">
    <a href="results.html" class="btn btn-success"><i class="fas fa-chart-bar"></i> View Results</a>
    <button id="logoutBtn" class="btn btn-outline-light"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const candidatesList = document.getElementById("candidatesList");
  const voteForm = document.getElementById("voteForm");
  const voteStatusBox = document.getElementById("voteStatusBox");
  const countdownEl = document.getElementById("countdown");
  const logoutBtn = document.getElementById("logoutBtn");
  const placeholderImg = "https://via.placeholder.com/140?text=No+Image";

  let candidates = JSON.parse(localStorage.getItem("candidates")) || [];
  let positions = [...new Set(candidates.map(c => c.position))];

  // Render candidates
  function renderCandidates() {
    candidatesList.innerHTML = "";
    positions.forEach(pos => {
      const group = candidates.filter(c => c.position === pos);
      let html = `<div class="col-12"><h5 class="mt-3"><i class="fas fa-briefcase me-1"></i>${pos}</h5><div class="row g-3">`;

      group.forEach((cand, idx) => {
        const imgSrc = cand.image || placeholderImg;
        html += `
          <div class="col-md-4 col-sm-6">
            <div class="card shadow-sm text-center p-3">
              <img src="${imgSrc}" class="candidate-img" alt="Profile">
              <h5 class="card-title mt-2">${cand.name}</h5>
              <div class="form-check mt-2">
                <input class="form-check-input" type="radio" name="${cand.position}" value="${cand.name}" id="${cand.position}-${idx}">
                <label class="form-check-label" for="${cand.position}-${idx}">Select</label>
              </div>
            </div>
          </div>
        `;
      });

      // "No Vote / Skip" option
      html += `
        <div class="col-md-4 col-sm-6">
          <div class="card shadow-sm text-center p-3">
            <h5 class="card-title mt-2">No Vote / Skip</h5>
            <div class="form-check mt-2">
              <input class="form-check-input" type="radio" name="${pos}" value="" id="${pos}-skip">
              <label class="form-check-label" for="${pos}-skip">Skip</label>
            </div>
          </div>
        </div>
      `;

      html += `</div></div>`;
      candidatesList.innerHTML += html;
    });
  }

  // Voting schedule
  function checkVotingSchedule() {
    function updateCountdown() {
      const schedule = JSON.parse(localStorage.getItem("votingSchedule"));
      const now = new Date().getTime();

      if (!schedule) {
        countdownEl.textContent = "⚠️ No voting schedule set.";
        voteForm.querySelector("button[type='submit']").disabled = true;
        return;
      }

      const start = new Date(schedule.start).getTime();
      const end = new Date(schedule.end).getTime();

      if (now < start) {
        countdownEl.textContent = "Voting starts in " + formatTime(start - now);
        voteForm.querySelector("button[type='submit']").disabled = true;
      } else if (now >= start && now <= end) {
        countdownEl.textContent = "Voting ends in " + formatTime(end - now);
        voteForm.querySelector("button[type='submit']").disabled = false;
      } else {
        countdownEl.textContent = "Voting has ended.";
        voteForm.querySelector("button[type='submit']").disabled = true;
      }
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
  }

  function formatTime(ms) {
    const d = Math.floor(ms / (1000*60*60*24));
    const h = Math.floor((ms % (1000*60*60*24)) / (1000*60*60));
    const m = Math.floor((ms % (1000*60*60)) / (1000*60));
    const s = Math.floor((ms % (1000*60)) / 1000);
    return `${d}d ${h}h ${m}m ${s}s`;
  }

  // Submit vote
  voteForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const schedule = JSON.parse(localStorage.getItem("votingSchedule"));
    const now = new Date().getTime();

    if (!schedule || now < new Date(schedule.start).getTime() || now > new Date(schedule.end).getTime()) {
      showMessage("danger", "Voting is not open right now.");
      return;
    }

    let ballot = {};
    positions.forEach(pos => {
      const selected = document.querySelector(`input[name="${pos}"]:checked`);
      ballot[pos] = selected ? selected.value : ""; 
    });

    const currentUser = JSON.parse(localStorage.getItem("currentUser"));
    if (!currentUser) {
      showMessage("danger", "Please log in to vote!");
      return;
    }

    let allVotes = JSON.parse(localStorage.getItem("votesList")) || [];
    if (allVotes.some(v => v.user === currentUser.username)) {
      showMessage("danger", "You have already voted!");
      return;
    }

    if (!confirm("Are you sure you want to submit your vote?")) return;

    allVotes.push({ user: currentUser.username, ballot });
    localStorage.setItem("votesList", JSON.stringify(allVotes));

    showMessage("success", "Vote submitted successfully!");
    voteForm.reset();
  });

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
  });

  function showMessage(type, msg) {
    voteStatusBox.innerHTML = `<div class="alert alert-${type}"><i class="fas fa-info-circle"></i> ${msg}</div>`;
    setTimeout(() => voteStatusBox.innerHTML = "", 4000);
  }

  renderCandidates();
  checkVotingSchedule();
});
</script>
</body>
</html>
